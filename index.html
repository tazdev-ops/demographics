<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive dashboard for analyzing global fertility rates with advanced visualizations and data export capabilities">
    <title>Global Fertility Rate Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light theme colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-tertiary: #adb5bd;
            --accent-primary: #007bff;
            --accent-hover: #0056b3;
            --border-color: #dee2e6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            
            /* Fertility rate colors */
            --rate-very-low: #dc3545;
            --rate-low: #fd7e14;
            --rate-medium: #0dcaf0;
            --rate-high: #198754;
            
            /* Status colors */
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            
            /* Animations */
            --transition-speed: 200ms;
            --animation-speed: 300ms;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --text-tertiary: #6c757d;
            --accent-primary: #4dabf7;
            --accent-hover: #339af0;
            --border-color: #495057;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --rate-very-low: #ff6b6b;
            --rate-low: #ffa94d;
            --rate-medium: #4dabf7;
            --rate-high: #51cf66;
        }

        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* Layout components */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            flex: 1;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Theme toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-speed);
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background-color: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        /* Main content */
        main {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        /* Dashboard sections */
        .dashboard-section {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        }

        .dashboard-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        select, input, button {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all var(--transition-speed);
        }

        select:hover, input:hover {
            border-color: var(--accent-primary);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        button {
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            border: none;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--bg-secondary);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Search input */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead {
            background-color: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem;
        }

        .sortable:hover {
            color: var(--accent-primary);
        }

        .sort-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
        }

        tbody tr {
            transition: background-color var(--transition-speed);
        }

        tbody tr:hover {
            background-color: var(--bg-secondary);
        }

        tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* Data cell styling */
        .value-positive {
            color: var(--rate-high);
            font-weight: 500;
        }

        .value-negative {
            color: var(--rate-very-low);
            font-weight: 500;
        }

        .rank-cell {
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* Charts */
        .chart-container {
            min-height: 500px;
            margin-bottom: 1.5rem;
        }

        .chart-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-speed);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        /* Export controls */
        .export-controls {
            display: flex;
            gap: 0.5rem;
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Tooltips */
        .tooltip {
            position: absolute;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            box-shadow: var(--shadow-md);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-speed);
            z-index: 1000;
        }

        .tooltip.show {
            opacity: 1;
        }

        /* Footer */
        footer {
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            padding: 2rem;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
            
            .dashboard-section {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                font-size: 0.875rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            header, footer, .controls-grid, .export-controls, .theme-toggle {
                display: none;
            }
            
            .dashboard-section {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>Global Fertility Rate Analytics</h1>
                    <p class="header-subtitle">Comprehensive analysis of fertility trends worldwide (1960-2023)</p>
                </div>
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon">🌙</span>
                    <span class="theme-text">Dark Mode</span>
                </button>
            </div>
        </header>

        <main>
            <!-- Loading overlay -->
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner"></div>
            </div>

            <!-- Statistics Overview -->
            <section class="dashboard-section" id="stats-section" style="display: none;">
                <div class="section-header">
                    <h2>Global Statistics Overview</h2>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <!-- Stats cards will be dynamically inserted here -->
                </div>
            </section>

            <!-- Map Visualization -->
            <section class="dashboard-section" id="map-section" style="display: none;">
                <div class="section-header">
                    <h2>Geographic Distribution</h2>
                    <div class="export-controls">
                        <button class="btn-secondary" id="export-map">
                            <span>📊</span> Export Image
                        </button>
                    </div>
                </div>
                <div class="chart-tabs">
                    <button class="tab active" data-view="map">World Map</button>
                    <button class="tab" data-view="trends">Trend Analysis</button>
                    <button class="tab" data-view="comparison">Country Comparison</button>
                </div>
                <div class="chart-container" id="visualization-container"></div>
            </section>

            <!-- Data Analysis -->
            <section class="dashboard-section" id="analysis-section" style="display: none;">
                <div class="section-header">
                    <h2>Detailed Data Analysis</h2>
                    <div class="export-controls">
                        <button class="btn-secondary" id="export-csv">
                            <span>📄</span> Export CSV
                        </button>
                        <button class="btn-secondary" id="export-pdf">
                            <span>📑</span> Export PDF
                        </button>
                    </div>
                </div>
                
                <div class="controls-grid">
                    <div class="control-group">
                        <label for="start-year">Start Year</label>
                        <select id="start-year" disabled></select>
                    </div>
                    <div class="control-group">
                        <label for="end-year">End Year</label>
                        <select id="end-year" disabled></select>
                    </div>
                    <div class="control-group">
                        <label for="rank-by">Ranking Metric</label>
                        <select id="rank-by" disabled>
                            <option value="decrease_abs">Largest Decrease (Absolute)</option>
                            <option value="decrease_pct">Largest Decrease (%)</option>
                            <option value="increase_abs">Largest Increase (Absolute)</option>
                            <option value="increase_pct">Largest Increase (%)</option>
                            <option value="current_lowest">Current Lowest Rate</option>
                            <option value="current_highest">Current Highest Rate</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="search">Search Countries</label>
                        <div class="search-container">
                            <span class="search-icon">🔍</span>
                            <input type="text" id="search" class="search-input" placeholder="Type to search..." disabled>
                        </div>
                    </div>
                </div>
                
                <button class="btn-primary" id="analyze-button" disabled style="width: 100%;">
                    Analyze Data
                </button>
                
                <div class="results-container" style="margin-top: 2rem;">
                    <h3 id="results-title" style="margin-bottom: 1rem;"></h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="rank">
                                        Rank
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th class="sortable" data-sort="country">
                                        Country/Region
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th class="sortable" data-sort="startValue" id="start-year-header">
                                        Start Year
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th class="sortable" data-sort="endValue" id="end-year-header">
                                        End Year
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th class="sortable" data-sort="absChange">
                                        Absolute Change
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th class="sortable" data-sort="pctChange">
                                        % Change
                                        <span class="sort-indicator"></span>
                                    </th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <!-- Table rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Data Source: The World Bank | Indicator: Fertility rate, total (births per woman) | SP.DYN.TFRT.IN</p>
            <p>Last updated: January 2025 | Built with ❤️ for data analysis</p>
        </footer>
    </div>

    <script>
        // Enhanced Global Fertility Rate Dashboard
        class FertilityDashboard {
            constructor() {
                // Configuration
                this.CSV_FILE = 'API_SP.DYN.TFRT.IN_DS2_EN_csv_v2_37712.csv';
                this.DEBOUNCE_DELAY = 300;
                this.ANIMATION_DURATION = 300;
                
                // State management
                this.state = {
                    data: [],
                    headers: [],
                    filteredData: [],
                    currentSort: { key: 'decrease_abs', direction: 'desc' },
                    currentView: 'map',
                    theme: localStorage.getItem('theme') || 'light',
                    isLoading: false
                };
                
                // Country code mapping
                this.countryCodeMap = {
                    "Afghanistan": "AFG", "Angola": "AGO", "Albania": "ALB", "Andorra": "AND",
                    "United Arab Emirates": "ARE", "Argentina": "ARG", "Armenia": "ARM",
                    "American Samoa": "ASM", "Antigua and Barbuda": "ATG", "Australia": "AUS",
                    "Austria": "AUT", "Azerbaijan": "AZE", "Burundi": "BDI", "Belgium": "BEL",
                    "Benin": "BEN", "Burkina Faso": "BFA", "Bangladesh": "BGD", "Bulgaria": "BGR",
                    "Bahrain": "BHR", "Bahamas, The": "BHS", "Bosnia and Herzegovina": "BIH",
                    "Belarus": "BLR", "Belize": "BLZ", "Bermuda": "BMU", "Bolivia": "BOL",
                    "Brazil": "BRA", "Barbados": "BRB", "Brunei Darussalam": "BRN", "Bhutan": "BTN",
                    "Botswana": "BWA", "Central African Republic": "CAF", "Canada": "CAN",
                    "Switzerland": "CHE", "Channel Islands": "CHI", "Chile": "CHL", "China": "CHN",
                    "Cote d'Ivoire": "CIV", "Cameroon": "CMR", "Congo, Dem. Rep.": "COD",
                    "Congo, Rep.": "COG", "Colombia": "COL", "Comoros": "COM", "Cabo Verde": "CPV",
                    "Costa Rica": "CRI", "Cuba": "CUB", "Curacao": "CUW", "Cayman Islands": "CYM",
                    "Cyprus": "CYP", "Czechia": "CZE", "Germany": "DEU", "Djibouti": "DJI",
                    "Dominica": "DMA", "Denmark": "DNK", "Dominican Republic": "DOM", "Algeria": "DZA",
                    "Ecuador": "ECU", "Egypt, Arab Rep.": "EGY", "Eritrea": "ERI", "Spain": "ESP",
                    "Estonia": "EST", "Ethiopia": "ETH", "Finland": "FIN", "Fiji": "FJI",
                    "France": "FRA", "Faroe Islands": "FRO", "Micronesia, Fed. Sts.": "FSM",
                    "Gabon": "GAB", "United Kingdom": "GBR", "Georgia": "GEO", "Ghana": "GHA",
                    "Gibraltar": "GIB", "Guinea": "GIN", "Gambia, The": "GMB", "Guinea-Bissau": "GNB",
                    "Equatorial Guinea": "GNQ", "Greece": "GRC", "Grenada": "GRD", "Greenland": "GRL",
                    "Guatemala": "GTM", "Guam": "GUM", "Guyana": "GUY", "Hong Kong SAR, China": "HKG",
                    "Honduras": "HND", "Croatia": "HRV", "Haiti": "HTI", "Hungary": "HUN",
                    "Indonesia": "IDN", "Isle of Man": "IMN", "India": "IND", "Ireland": "IRL",
                    "Iran, Islamic Rep.": "IRN", "Iraq": "IRQ", "Iceland": "ISL", "Israel": "ISR",
                    "Italy": "ITA", "Jamaica": "JAM", "Jordan": "JOR", "Japan": "JPN",
                    "Kazakhstan": "KAZ", "Kenya": "KEN", "Kyrgyz Republic": "KGZ", "Cambodia": "KHM",
                    "Kiribati": "KIR", "St. Kitts and Nevis": "KNA", "Korea, Rep.": "KOR",
                    "Kuwait": "KWT", "Lao PDR": "LAO", "Lebanon": "LBN", "Liberia": "LBR",
                    "Libya": "LBY", "St. Lucia": "LCA", "Liechtenstein": "LIE", "Sri Lanka": "LKA",
                    "Lesotho": "LSO", "Lithuania": "LTU", "Luxembourg": "LUX", "Latvia": "LVA",
                    "Macao SAR, China": "MAC", "St. Martin (French part)": "MAF", "Morocco": "MAR",
                    "Monaco": "MCO", "Moldova": "MDA", "Madagascar": "MDG", "Maldives": "MDV",
                    "Mexico": "MEX", "Marshall Islands": "MHL", "North Macedonia": "MKD", "Mali": "MLI",
                    "Malta": "MLT", "Myanmar": "MMR", "Montenegro": "MNE", "Mongolia": "MNG",
                    "Northern Mariana Islands": "MNP", "Mozambique": "MOZ", "Mauritania": "MRT",
                    "Mauritius": "MUS", "Malawi": "MWI", "Malaysia": "MYS", "Namibia": "NAM",
                    "New Caledonia": "NCL", "Niger": "NER", "Nigeria": "NGA", "Nicaragua": "NIC",
                    "Netherlands": "NLD", "Norway": "NOR", "Nepal": "NPL", "Nauru": "NRU",
                    "New Zealand": "NZL", "Oman": "OMN", "Pakistan": "PAK", "Panama": "PAN",
                    "Peru": "PER", "Philippines": "PHL", "Palau": "PLW", "Papua New Guinea": "PNG",
                    "Poland": "POL", "Puerto Rico (US)": "PRI", "Korea, Dem. People's Rep.": "PRK",
                    "Portugal": "PRT", "Paraguay": "PRY", "West Bank and Gaza": "PSE",
                    "French Polynesia": "PYF", "Qatar": "QAT", "Romania": "ROU",
                    "Russian Federation": "RUS", "Rwanda": "RWA", "Saudi Arabia": "SAU",
                    "Sudan": "SDN", "Senegal": "SEN", "Singapore": "SGP", "Solomon Islands": "SLB",
                    "Sierra Leone": "SLE", "El Salvador": "SLV", "San Marino": "SMR", "Somalia": "SOM",
                    "Serbia": "SRB", "South Sudan": "SSD", "Sao Tome and Principe": "STP",
                    "Suriname": "SUR", "Slovak Republic": "SVK", "Slovenia": "SVN", "Sweden": "SWE",
                    "Eswatini": "SWZ", "Sint Maarten (Dutch part)": "SXM", "Seychelles": "SYC",
                    "Syrian Arab Republic": "SYR", "Turks and Caicos Islands": "TCA", "Chad": "TCD",
                    "Togo": "TGO", "Thailand": "THA", "Tajikistan": "TJK", "Turkmenistan": "TKM",
                    "Timor-Leste": "TLS", "Tonga": "TON", "Trinidad and Tobago": "TTO",
                    "Tunisia": "TUN", "Turkiye": "TUR", "Tuvalu": "TUV", "Tanzania": "TZA",
                    "Uganda": "UGA", "Ukraine": "UKR", "Uruguay": "URY", "United States": "USA",
                    "Uzbekistan": "UZB", "St. Vincent and the Grenadines": "VCT",
                    "Venezuela, RB": "VEN", "British Virgin Islands": "VGB", "Virgin Islands (U.S.)": "VIR",
                    "Viet Nam": "VNM", "Vanuatu": "VUT", "Samoa": "WSM", "Kosovo": "XKX",
                    "Yemen, Rep.": "YEM", "South Africa": "ZAF", "Zambia": "ZMB", "Zimbabwe": "ZWE"
                };
                
                // Cache DOM elements
                this.elements = this.cacheElements();
                
                // Initialize
                this.init();
            }
            
            cacheElements() {
                return {
                    // Sections
                    statsSection: document.getElementById('stats-section'),
                    mapSection: document.getElementById('map-section'),
                    analysisSection: document.getElementById('analysis-section'),
                    loadingOverlay: document.getElementById('loading-overlay'),
                    
                    // Controls
                    startYear: document.getElementById('start-year'),
                    endYear: document.getElementById('end-year'),
                    rankBy: document.getElementById('rank-by'),
                    search: document.getElementById('search'),
                    analyzeButton: document.getElementById('analyze-button'),
                    themeToggle: document.getElementById('theme-toggle'),
                    
                    // Results
                    resultsTitle: document.getElementById('results-title'),
                    resultsTbody: document.getElementById('results-tbody'),
                    startYearHeader: document.getElementById('start-year-header'),
                    endYearHeader: document.getElementById('end-year-header'),
                    
                    // Visualizations
                    visualizationContainer: document.getElementById('visualization-container'),
                    statsGrid: document.getElementById('stats-grid'),
                    
                    // Export buttons
                    exportMap: document.getElementById('export-map'),
                    exportCSV: document.getElementById('export-csv'),
                    exportPDF: document.getElementById('export-pdf'),
                    
                    // Tabs
                    chartTabs: document.querySelectorAll('.tab'),
                    sortableHeaders: document.querySelectorAll('.sortable')
                };
            }
            
            async init() {
                try {
                    // Apply saved theme
                    this.applyTheme();
                    
                    // Show loading state
                    this.setLoading(true);
                    
                    // Load data
                    await this.loadData();
                    
                    // Initialize UI
                    this.initializeUI();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Initial render
                    this.updateVisualization();
                    this.analyzeData();
                    
                    // Hide loading state
                    this.setLoading(false);
                    
                    // Show sections
                    this.elements.statsSection.style.display = 'block';
                    this.elements.mapSection.style.display = 'block';
                    this.elements.analysisSection.style.display = 'block';
                    
                } catch (error) {
                    console.error('Initialization failed:', error);
                    this.showError('Failed to initialize dashboard. Please refresh the page.');
                }
            }
            
            async loadData() {
                try {
                    const response = await fetch(this.CSV_FILE);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Could not load data file`);
                    }
                    
                    const csvText = await response.text();
                    this.parseCSV(csvText);
                    
                } catch (error) {
                    throw new Error(`Data loading failed: ${error.message}`);
                }
            }
            
            parseCSV(text) {
                const lines = text.trim().split(/\r?\n/);
                this.state.headers = lines[0].split(',').map(h => h.trim());
                
                this.state.data = lines.slice(1).map(line => {
                    const values = this.parseCSVLine(line);
                    const row = {};
                    
                    this.state.headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    
                    return row;
                });
            }
            
            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current.trim());
                return values;
            }
            
            initializeUI() {
                // Populate year selectors
                const years = this.state.headers.slice(1).filter(h => /^\d{4}$/.test(h));
                
                years.forEach(year => {
                    const startOption = document.createElement('option');
                    startOption.value = year;
                    startOption.textContent = year;
                    this.elements.startYear.appendChild(startOption);
                    
                    const endOption = document.createElement('option');
                    endOption.value = year;
                    endOption.textContent = year;
                    this.elements.endYear.appendChild(endOption);
                });
                
                // Set default values
                this.elements.startYear.value = '1960';
                this.elements.endYear.value = '2023';
                
                // Enable controls
                this.elements.startYear.disabled = false;
                this.elements.endYear.disabled = false;
                this.elements.rankBy.disabled = false;
                this.elements.search.disabled = false;
                this.elements.analyzeButton.disabled = false;
                
                // Update global stats
                this.updateGlobalStats();
            }
            
            setupEventListeners() {
                // Analysis controls
                this.elements.analyzeButton.addEventListener('click', () => this.analyzeData());
                this.elements.search.addEventListener('input', this.debounce(() => this.filterData(), this.DEBOUNCE_DELAY));
                
                // Sorting
                this.elements.sortableHeaders.forEach(header => {
                    header.addEventListener('click', (e) => this.handleSort(e));
                });
                
                // Theme toggle
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // Chart tabs
                this.elements.chartTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchView(e.target.dataset.view));
                });
                
                // Export functions
                this.elements.exportMap.addEventListener('click', () => this.exportMap());
                this.elements.exportCSV.addEventListener('click', () => this.exportCSV());
                this.elements.exportPDF.addEventListener('click', () => this.exportPDF());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.exportCSV();
                                break;
                            case 'p':
                                e.preventDefault();
                                this.exportPDF();
                                break;
                        }
                    }
                });
            }
            
            updateGlobalStats() {
                const currentYear = '2023';
                const stats = this.calculateGlobalStats(currentYear);
                
                this.elements.statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Global Average (2023)</div>
                        <div class="stat-value">${stats.globalAverage.toFixed(2)}</div>
                        <div class="stat-change ${stats.yearChange < 0 ? 'value-negative' : 'value-positive'}">
                            ${stats.yearChange > 0 ? '+' : ''}${stats.yearChange.toFixed(2)}% from 2022
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Countries Below Replacement</div>
                        <div class="stat-value">${stats.belowReplacement}</div>
                        <div class="stat-change">${stats.belowReplacementPct.toFixed(1)}% of countries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Lowest Rate</div>
                        <div class="stat-value">${stats.lowestRate.value.toFixed(2)}</div>
                        <div class="stat-change">${stats.lowestRate.country}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Highest Rate</div>
                        <div class="stat-value">${stats.highestRate.value.toFixed(2)}</div>
                        <div class="stat-change">${stats.highestRate.country}</div>
                    </div>
                `;
            }
            
            calculateGlobalStats(year) {
                const validData = this.state.data.filter(row => {
                    const value = parseFloat(row[year]);
                    return !isNaN(value) && value > 0;
                });
                
                const values = validData.map(row => parseFloat(row[year]));
                const globalAverage = values.reduce((sum, val) => sum + val, 0) / values.length;
                
                // Calculate year-over-year change
                const previousYear = (parseInt(year) - 1).toString();
                const previousValues = validData
                    .map(row => parseFloat(row[previousYear]))
                    .filter(val => !isNaN(val));
                const previousAverage = previousValues.reduce((sum, val) => sum + val, 0) / previousValues.length;
                const yearChange = ((globalAverage - previousAverage) / previousAverage) * 100;
                
                // Countries below replacement
                const belowReplacement = values.filter(val => val < 2.1).length;
                const belowReplacementPct = (belowReplacement / values.length) * 100;
                
                // Find extremes
                const sortedData = validData.sort((a, b) => parseFloat(a[year]) - parseFloat(b[year]));
                const lowestRate = {
                    country: sortedData[0][this.state.headers[0]],
                    value: parseFloat(sortedData[0][year])
                };
                const highestRate = {
                    country: sortedData[sortedData.length - 1][this.state.headers[0]],
                    value: parseFloat(sortedData[sortedData.length - 1][year])
                };
                
                return {
                    globalAverage,
                    yearChange,
                    belowReplacement,
                    belowReplacementPct,
                    lowestRate,
                    highestRate
                };
            }
            
            updateVisualization() {
                switch(this.state.currentView) {
                    case 'map':
                        this.drawWorldMap();
                        break;
                    case 'trends':
                        this.drawTrendAnalysis();
                        break;
                    case 'comparison':
                        this.drawCountryComparison();
                        break;
                }
            }
            
            drawWorldMap() {
                const year = this.elements.endYear.value;
                const mapData = this.prepareMapData(year);
                
                const data = Object.values(mapData).map(category => ({
                    type: 'choropleth',
                    locationmode: 'ISO-3',
                    locations: category.locations,
                    z: category.z,
                    text: category.text,
                    hoverinfo: 'text',
                    name: category.name,
                    colorscale: [[0, category.color], [1, category.color]],
                    showscale: false
                }));
                
                const layout = {
                    title: {
                        text: `Global Fertility Rates - ${year}`,
                        font: { size: 20 }
                    },
                    geo: {
                        projection: { type: 'natural earth' },
                        showframe: false,
                        showcoastlines: true,
                        coastlinecolor: 'RebeccaPurple'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.1,
                        x: 0.5,
                        xanchor: 'center'
                    },
                    margin: { t: 50, b: 40, l: 0, r: 0 }
                };
                
                Plotly.newPlot(this.elements.visualizationContainer, data, layout, {
                    responsive: true,
                    displayModeBar: false
                });
            }
            
            prepareMapData(year) {
                const colors = {
                    very_low: getComputedStyle(document.documentElement).getPropertyValue('--rate-very-low').trim(),
                    low: getComputedStyle(document.documentElement).getPropertyValue('--rate-low').trim(),
                    medium: getComputedStyle(document.documentElement).getPropertyValue('--rate-medium').trim(),
                    high: getComputedStyle(document.documentElement).getPropertyValue('--rate-high').trim()
                };
                
                const categories = {
                    very_low: { locations: [], z: [], text: [], name: 'Very Low (< 1.3)', color: colors.very_low },
                    low: { locations: [], z: [], text: [], name: 'Low (1.3 - 2.1)', color: colors.low },
                    medium: { locations: [], z: [], text: [], name: 'Medium (2.1 - 3.0)', color: colors.medium },
                    high: { locations: [], z: [], text: [], name: 'High (> 3.0)', color: colors.high }
                };
                
                this.state.data.forEach(row => {
                    const country = row[this.state.headers[0]];
                    const code = this.countryCodeMap[country];
                    const value = parseFloat(row[year]);
                    
                    if (code && !isNaN(value)) {
                        const text = `${country}: ${value.toFixed(2)}`;
                        let category;
                        
                        if (value < 1.3) category = categories.very_low;
                        else if (value < 2.1) category = categories.low;
                        else if (value <= 3.0) category = categories.medium;
                        else category = categories.high;
                        
                        category.locations.push(code);
                        category.z.push(value);
                        category.text.push(text);
                    }
                });
                
                return categories;
            }
            
            drawTrendAnalysis() {
                const topCountries = this.getTopCountriesByChange();
                const years = this.state.headers.slice(1).filter(h => /^\d{4}$/.test(h));
                
                const traces = topCountries.map(country => {
                    const values = years.map(year => {
                        const value = parseFloat(country.data[year]);
                        return isNaN(value) ? null : value;
                    });
                    
                    return {
                        x: years,
                        y: values,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: country.name,
                        line: { width: 2 },
                        marker: { size: 4 }
                    };
                });
                
                const layout = {
                    title: 'Fertility Rate Trends - Top 10 Countries by Change',
                    xaxis: { title: 'Year' },
                    yaxis: { title: 'Fertility Rate (births per woman)' },
                    hovermode: 'x unified',
                    legend: {
                        orientation: 'v',
                        yanchor: 'middle',
                        y: 0.5,
                        xanchor: 'left',
                        x: 1.05
                    }
                };
                
                Plotly.newPlot(this.elements.visualizationContainer, traces, layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false
                });
            }
            
            getTopCountriesByChange() {
                const startYear = this.elements.startYear.value;
                const endYear = this.elements.endYear.value;
                
                const changes = this.state.data.map(row => {
                    const country = row[this.state.headers[0]];
                    const startValue = parseFloat(row[startYear]);
                    const endValue = parseFloat(row[endYear]);
                    
                    if (isNaN(startValue) || isNaN(endValue)) return null;
                    
                    return {
                        name: country,
                        data: row,
                        change: Math.abs(endValue - startValue)
                    };
                }).filter(Boolean);
                
                return changes
                    .sort((a, b) => b.change - a.change)
                    .slice(0, 10);
            }
            
            drawCountryComparison() {
                const selectedCountries = ['United States', 'China', 'India', 'Japan', 'Germany', 'Brazil'];
                const year = this.elements.endYear.value;
                
                const data = selectedCountries.map(country => {
                    const row = this.state.data.find(r => r[this.state.headers[0]] === country);
                    if (!row) return null;
                    
                    const currentValue = parseFloat(row[year]);
                    const previousValue = parseFloat(row['1960']);
                    
                    return {
                        country,
                        current: currentValue,
                        previous: previousValue,
                        change: currentValue - previousValue
                    };
                }).filter(Boolean);
                
                const trace1 = {
                    x: data.map(d => d.country),
                    y: data.map(d => d.current),
                    name: year,
                    type: 'bar',
                    marker: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim() }
                };
                
                const trace2 = {
                    x: data.map(d => d.country),
                    y: data.map(d => d.previous),
                    name: '1960',
                    type: 'bar',
                    marker: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() }
                };
                
                const layout = {
                    title: 'Fertility Rate Comparison: 1960 vs ' + year,
                    xaxis: { title: 'Country' },
                    yaxis: { title: 'Fertility Rate' },
                    barmode: 'group'
                };
                
                Plotly.newPlot(this.elements.visualizationContainer, [trace2, trace1], layout, {
                    responsive: true,
                    displayModeBar: false
                });
            }
            
            analyzeData() {
                const startYear = this.elements.startYear.value;
                const endYear = this.elements.endYear.value;
                
                if (parseInt(startYear) >= parseInt(endYear)) {
                    this.showError('Start year must be before end year');
                    return;
                }
                
                // Update headers
                this.elements.startYearHeader.textContent = startYear;
                this.elements.endYearHeader.textContent = endYear;
                
                // Calculate changes
                const analyzed = this.state.data.map(row => {
                    const country = row[this.state.headers[0]];
                    const startValue = parseFloat(row[startYear]);
                    const endValue = parseFloat(row[endYear]);
                    
                    if (isNaN(startValue) || isNaN(endValue) || startValue === 0) return null;
                    
                    const absChange = endValue - startValue;
                    const pctChange = (absChange / startValue) * 100;
                    
                    return {
                        country,
                        startValue,
                        endValue,
                        absChange,
                        pctChange,
                        trend: this.calculateTrend(row, startYear, endYear)
                    };
                }).filter(Boolean);
                
                // Apply initial sort
                this.state.filteredData = this.sortData(analyzed, this.elements.rankBy.value);
                
                // Update title
                this.elements.resultsTitle.textContent = `Analysis Results: ${startYear} - ${endYear}`;
                
                // Render table
                this.renderTable();
            }
            
            calculateTrend(row, startYear, endYear) {
                const years = [];
                const values = [];
                
                for (let year = parseInt(startYear); year <= parseInt(endYear); year++) {
                    const value = parseFloat(row[year.toString()]);
                    if (!isNaN(value)) {
                        years.push(year);
                        values.push(value);
                    }
                }
                
                if (years.length < 2) return 'insufficient-data';
                
                // Simple linear regression
                const n = years.length;
                const sumX = years.reduce((a, b) => a + b, 0);
                const sumY = values.reduce((a, b) => a + b, 0);
                const sumXY = years.reduce((sum, x, i) => sum + x * values[i], 0);
                const sumX2 = years.reduce((sum, x) => sum + x * x, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                
                if (slope < -0.01) return 'declining';
                if (slope > 0.01) return 'rising';
                return 'stable';
            }
            
            sortData(data, sortKey) {
                const sortConfig = {
                    'decrease_abs': { key: 'absChange', dir: 1 },
                    'decrease_pct': { key: 'pctChange', dir: 1 },
                    'increase_abs': { key: 'absChange', dir: -1 },
                    'increase_pct': { key: 'pctChange', dir: -1 },
                    'current_lowest': { key: 'endValue', dir: 1 },
                    'current_highest': { key: 'endValue', dir: -1 }
                };
                
                const config = sortConfig[sortKey] || sortConfig['decrease_abs'];
                
                return [...data].sort((a, b) => {
                    return (a[config.key] - b[config.key]) * config.dir;
                });
            }
            
            handleSort(event) {
                const header = event.currentTarget;
                const sortKey = header.dataset.sort;
                
                // Update sort direction
                if (this.state.currentSort.key === sortKey) {
                    this.state.currentSort.direction = 
                        this.state.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.currentSort.key = sortKey;
                    this.state.currentSort.direction = 'desc';
                }
                
                // Sort data
                this.state.filteredData.sort((a, b) => {
                    let aVal = a[sortKey];
                    let bVal = b[sortKey];
                    
                    if (typeof aVal === 'string') {
                        return this.state.currentSort.direction === 'asc' 
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    }
                    
                    return this.state.currentSort.direction === 'asc'
                        ? aVal - bVal
                        : bVal - aVal;
                });
                
                // Update UI
                this.updateSortIndicators();
                this.renderTable();
            }
            
            updateSortIndicators() {
                this.elements.sortableHeaders.forEach(header => {
                    const indicator = header.querySelector('.sort-indicator');
                    header.classList.remove('asc', 'desc');
                    
                    if (header.dataset.sort === this.state.currentSort.key) {
                        header.classList.add(this.state.currentSort.direction);
                        indicator.textContent = this.state.currentSort.direction === 'asc' ? '↑' : '↓';
                    } else {
                        indicator.textContent = '';
                    }
                });
            }
            
            filterData() {
                const searchTerm = this.elements.search.value.toLowerCase();
                
                if (!searchTerm) {
                    this.renderTable();
                    return;
                }
                
                const filtered = this.state.filteredData.filter(row => 
                    row.country.toLowerCase().includes(searchTerm)
                );
                
                this.renderTable(filtered);
            }
            
            renderTable(data = this.state.filteredData) {
                if (!data || data.length === 0) {
                    this.elements.resultsTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">
                                No data available for the selected criteria
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const html = data.map((row, index) => {
                    const changeClass = row.absChange < 0 ? 'value-negative' : 'value-positive';
                    const trendIcon = {
                        'declining': '📉',
                        'rising': '📈',
                        'stable': '➡️',
                        'insufficient-data': '❓'
                    }[row.trend];
                    
                    return `
                        <tr>
                            <td class="rank-cell">${index + 1}</td>
                            <td>${this.escapeHtml(row.country)}</td>
                            <td>${row.startValue.toFixed(3)}</td>
                            <td>${row.endValue.toFixed(3)}</td>
                            <td class="${changeClass}">
                                ${row.absChange > 0 ? '+' : ''}${row.absChange.toFixed(3)}
                            </td>
                            <td class="${changeClass}">
                                ${row.pctChange > 0 ? '+' : ''}${row.pctChange.toFixed(1)}%
                            </td>
                            <td style="text-align: center;">${trendIcon}</td>
                        </tr>
                    `;
                }).join('');
                
                this.elements.resultsTbody.innerHTML = html;
            }
            
            switchView(view) {
                this.state.currentView = view;
                
                // Update tab styles
                this.elements.chartTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.view === view);
                });
                
                // Update visualization
                this.updateVisualization();
            }
            
            // Export functions
            exportMap() {
                Plotly.downloadImage(this.elements.visualizationContainer, {
                    format: 'png',
                    width: 1200,
                    height: 800,
                    filename: `fertility-map-${new Date().toISOString().split('T')[0]}`
                });
            }
            
            exportCSV() {
                const data = this.state.filteredData;
                if (!data || data.length === 0) {
                    this.showError('No data to export');
                    return;
                }
                
                const headers = ['Rank', 'Country', 'Start Year', 'End Year', 'Absolute Change', 'Percent Change'];
                const rows = data.map((row, index) => [
                    index + 1,
                    row.country,
                    row.startValue.toFixed(3),
                    row.endValue.toFixed(3),
                    row.absChange.toFixed(3),
                    row.pctChange.toFixed(1) + '%'
                ]);
                
                const csv = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                this.downloadFile(csv, 'text/csv', `fertility-analysis-${new Date().toISOString().split('T')[0]}.csv`);
            }
            
            exportPDF() {
                // Simple PDF export using print
                window.print();
            }
            
            // Theme management
            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.state.theme);
                const icon = this.elements.themeToggle.querySelector('.theme-icon');
                const text = this.elements.themeToggle.querySelector('.theme-text');
                
                if (this.state.theme === 'dark') {
                    icon.textContent = '☀️';
                    text.textContent = 'Light Mode';
                } else {
                    icon.textContent = '🌙';
                    text.textContent = 'Dark Mode';
                }
            }
            
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', this.state.theme);
                this.applyTheme();
                
                // Redraw charts with new theme
                this.updateVisualization();
            }
            
            // Utility functions
            setLoading(isLoading) {
                this.state.isLoading = isLoading;
                this.elements.loadingOverlay.classList.toggle('active', isLoading);
            }
            
            showError(message) {
                // Create toast notification
                const toast = document.createElement('div');
                toast.className = 'tooltip show';
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: var(--danger);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    z-index: 2000;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
            
            downloadFile(content, mimeType, filename) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new FertilityDashboard();
        });
    </script>
</body>
</html>
